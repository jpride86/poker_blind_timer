<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FSOP Tournament App</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-6">FSOP Tournament App</h1>

    <!-- Auth Section -->
    <div id="auth-section" class="mb-6">
      <input id="email" type="email" placeholder="Email" class="block w-full p-2 rounded text-black mb-2">
      <input id="password" type="password" placeholder="Password" class="block w-full p-2 rounded text-black mb-2">
      <div class="flex gap-2">
        <button onclick="login()" class="bg-green-600 px-4 py-2 rounded">Login</button>
        <button onclick="register()" class="bg-blue-600 px-4 py-2 rounded">Register</button>
      </div>
      <button onclick="resetPassword()" class="underline text-sm mt-2">Forgot Password?</button>
    </div>

    <!-- User Info and Logout -->
    <div id="user-info" class="mb-6 hidden">
      <p id="user-email" class="text-sm text-gray-400 mb-2"></p>
      <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded">Logout</button>
    </div>

    <div id="league-table" class="bg-gray-800 p-4 rounded-xl mb-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">League Standings</h2>
      <table class="w-full text-sm">
        <thead><tr><th class="text-left">Name</th><th>Points</th><th>Games</th><th>Winnings</th></tr></thead>
        <tbody id="standings-body"></tbody>
      </table>
    </div>

    <div id="player-management" class="bg-gray-800 p-4 rounded-xl mb-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">Registered Players</h2>
      <ul id="player-list" class="mb-4 text-sm list-disc pl-5"></ul>
      <div class="flex gap-2">
        <input id="new-player-name" type="text" placeholder="Full Name" class="p-2 text-black rounded w-full">
        <button onclick="addPlayer()" class="bg-blue-600 px-4 py-2 rounded">Add Player</button>
      </div>
    </div>

    <div id="blind-timer" class="bg-gray-800 p-4 rounded-xl mb-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">Blind Timer</h2>
      <div class="mb-2">
        <p class="text-lg">Current Level: <span id="current-level">1</span></p>
        <p class="text-lg">Blinds: <span id="current-blinds">25 / 50</span></p>
        <p class="text-lg">Time Left: <span id="time-left">10:00</span></p>
      </div>
      <div class="flex gap-2">
        <button onclick="startTimer()" class="bg-green-600 px-4 py-2 rounded">Start</button>
        <button onclick="pauseTimer()" class="bg-yellow-600 px-4 py-2 rounded">Pause</button>
        <button onclick="nextLevel()" class="bg-blue-600 px-4 py-2 rounded">Next Level</button>
        <button onclick="resetTimer()" class="bg-red-600 px-4 py-2 rounded">Reset</button>
      </div>
    </div>

    <div id="event-creation" class="bg-gray-800 p-4 rounded-xl mb-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">Create New Tournament</h2>
      <input id="event-name" type="text" placeholder="Event Name" class="block w-full p-2 mb-2 rounded text-black">
      <input id="event-date" type="datetime-local" class="block w-full p-2 mb-2 rounded text-black">
      <input id="event-location" type="text" placeholder="Location" class="block w-full p-2 mb-2 rounded text-black">
      <input id="event-group-size" type="number" min="1" placeholder="Group Size (e.g. 8)" class="block w-full p-2 mb-2 rounded text-black">
      <textarea id="event-description" placeholder="Description (optional)" class="block w-full p-2 mb-2 rounded text-black"></textarea>
      <button onclick="createEvent()" class="bg-green-600 px-4 py-2 rounded">Create Event</button>
    </div>

    <!-- Upcoming Events Section -->
    <div id="upcoming-events" class="bg-gray-800 p-4 rounded-xl mb-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">Upcoming Events</h2>
      <ul id="events-list" class="list-disc pl-5 text-sm"></ul>
    </div>

  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDw-MxHBo6EYJwsFD67MPMZWZerX5Zq-9A",
      authDomain: "fsop-poker-blind-timer.firebaseapp.com",
      projectId: "fsop-poker-blind-timer",
      storageBucket: "fsop-poker-blind-timer.firebasestorage.app",
      messagingSenderId: "327865291955",
      appId: "1:327865291955:web:a3788ac8a27d98952a0cc6"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("auth-section").classList.add("hidden");
        document.getElementById("user-info").classList.remove("hidden");
        document.getElementById("user-email").textContent = "Logged in as: " + user.email;
        document.getElementById("league-table").classList.remove("hidden");
        document.getElementById("player-management").classList.remove("hidden");
        document.getElementById("blind-timer").classList.remove("hidden");
        document.getElementById("event-creation").classList.remove("hidden");
        document.getElementById("upcoming-events").classList.remove("hidden");

        loadLeagueTable(user.uid);
        loadPlayers();
        updateBlindDisplay();
        loadUpcomingEvents();

        db.collection("timerState").doc(user.uid).get().then(doc => {
          if (doc.exists) {
            const data = doc.data();
            currentLevel = data.level ?? 0;
            timeRemaining = data.timeRemaining ?? 600;
            updateBlindDisplay();
          }
        });
      } else {
        document.getElementById("auth-section").classList.remove("hidden");
        document.getElementById("user-info").classList.add("hidden");
        document.getElementById("user-email").textContent = "";
        document.getElementById("league-table").classList.add("hidden");
        document.getElementById("player-management").classList.add("hidden");
        document.getElementById("blind-timer").classList.add("hidden");
        document.getElementById("event-creation").classList.add("hidden");
        document.getElementById("upcoming-events").classList.add("hidden");
        document.getElementById("standings-body").innerHTML = "";
        document.getElementById("events-list").innerHTML = "";
      }
    });

    function loadUpcomingEvents() {
  const now = new Date();
  const user = firebase.auth().currentUser;

  db.collection("events")
    .where("date", ">", now)
    .orderBy("date", "asc")
    .onSnapshot(snapshot => {
      const list = document.getElementById("events-list");
      list.innerHTML = "";

      if (snapshot.empty) {
        list.innerHTML = "<li>No upcoming events.</li>";
        return;
      }

      snapshot.forEach(doc => {
        const event = doc.data();
        const eventId = doc.id;
        const dateStr = new Date(event.date.seconds * 1000).toLocaleString();

        const li = document.createElement("li");
        li.className = "mb-4";
        li.innerHTML = `
  <strong>${event.name}</strong> — ${dateStr}<br>
  ${event.location}<br>
  <button onclick="rsvpEvent('${eventId}')" class="mt-1 bg-blue-600 px-2 py-1 rounded text-sm">RSVP</button>
  <button onclick="cancelRsvpEvent('${eventId}')" class="mt-1 bg-red-600 px-2 py-1 rounded text-sm ml-2">Cancel RSVP</button>
  <span id="rsvp-status-${eventId}" class="text-sm ml-2"></span>
`;


        // Check if already RSVPed and show correct status
db.collection("events").doc(eventId).collection("rsvps").doc(user.uid).get()
  .then(rsvpDoc => {
    const statusSpan = li.querySelector(`#rsvp-status-${eventId}`);
    if (rsvpDoc.exists && statusSpan) {
      const status = rsvpDoc.data().status;
      if (status === "confirmed") {
        statusSpan.textContent = "✔ Confirmed RSVP";
        statusSpan.classList.add("text-green-400");
      } else {
        statusSpan.textContent = "⏳ Waitlisted";
        statusSpan.classList.add("text-yellow-400");
      }
    }
  });


// Fetch and display confirmed and waitlisted users
Promise.all([
  db.collection("events").doc(eventId).collection("rsvps")
    .where("status", "==", "confirmed")
    .orderBy("timestamp", "asc")
    .get(),
  db.collection("events").doc(eventId).collection("rsvps")
    .where("status", "==", "waitlist")
    .orderBy("timestamp", "asc")
    .get()
]).then(([confirmedSnap, waitlistSnap]) => {
  const confirmedNames = confirmedSnap.docs.map(doc => doc.data().email);
  const waitlistNames = waitlistSnap.docs.map(doc => doc.data().email);

  const listDiv = document.createElement("div");
  listDiv.className = "mt-2 text-sm";

  if (confirmedNames.length > 0) {
    listDiv.innerHTML += `<p class="text-green-400">✔ Confirmed: ${confirmedNames.join(', ')}</p>`;
  }

  if (waitlistNames.length > 0) {
    listDiv.innerHTML += `<p class="text-yellow-400">⏳ Waitlist: ${waitlistNames.join(', ')}</p>`;
  }

  li.appendChild(listDiv);
  list.appendChild(li);
});
      });
    });
}
function rsvpEvent(eventId) {
  const user = firebase.auth().currentUser;
  if (!user) return alert("You must be logged in to RSVP.");

  const eventRef = db.collection("events").doc(eventId);
  const rsvpsRef = eventRef.collection("rsvps");

  db.runTransaction(async (transaction) => {
    const eventDoc = await transaction.get(eventRef);
    if (!eventDoc.exists) throw "Event does not exist.";

    const groupSize = eventDoc.data().groupSize || 8;

    const snapshot = await rsvpsRef.orderBy("timestamp").get();
    const rsvpCount = snapshot.size;

    let status = rsvpCount < groupSize ? "confirmed" : "waitlist";

    transaction.set(rsvpsRef.doc(user.uid), {
      uid: user.uid,
      email: user.email,
      status,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    return status;
  }).then(status => {
    const statusSpan = document.getElementById(`rsvp-status-${eventId}`);
    if (status === "confirmed") {
      statusSpan.textContent = "✔ Confirmed RSVP";
      statusSpan.classList.remove("text-yellow-400");
      statusSpan.classList.add("text-green-400");
    } else {
      statusSpan.textContent = "⏳ Waitlisted";
      statusSpan.classList.remove("text-green-400");
      statusSpan.classList.add("text-yellow-400");
    }
  }).catch(error => {
    console.error("RSVP failed:", error);
    alert("There was a problem with your RSVP.");
  });
}
function cancelRsvpEvent(eventId) {
  const user = firebase.auth().currentUser;
  if (!user) return alert("You must be logged in.");

  const eventRef = db.collection("events").doc(eventId);
  const rsvpDocRef = eventRef.collection("rsvps").doc(user.uid);

  db.runTransaction(async (transaction) => {
    const rsvpDoc = await transaction.get(rsvpDocRef);
    if (!rsvpDoc.exists) throw "RSVP not found";

    const wasConfirmed = rsvpDoc.data().status === "confirmed";

    transaction.delete(rsvpDocRef);

    // Promote next waitlisted user if needed
    if (wasConfirmed) {
      const waitlistSnapshot = await eventRef.collection("rsvps")
        .where("status", "==", "waitlist")
        .orderBy("timestamp", "asc")
        .limit(1)
        .get();

      if (!waitlistSnapshot.empty) {
        const nextInLine = waitlistSnapshot.docs[0];
        transaction.update(nextInLine.ref, { status: "confirmed" });
      }
    }
  }).then(() => {
    loadUpcomingEvents(); // Refresh the list
  }).catch(err => {
    console.error("Cancel RSVP error:", err);
    alert("Could not cancel RSVP.");
  });
}

    
  </script>
</body>
</html>
