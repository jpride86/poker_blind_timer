import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signOut } from 'firebase/auth';
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  onSnapshot,
  query,
  increment,
  getDocs
} from 'firebase/firestore';

const firebaseConfig = {
  apiKey: "AIzaSyDw-MxHBo6EYJwsFD67MPMZWZerX5Zq-9A",
  authDomain: "fsop-poker-blind-timer.firebaseapp.com",
  projectId: "fsop-poker-blind-timer",
  storageBucket: "fsop-poker-blind-timer.firebasestorage.app",
  messagingSenderId: "327865291955",
  appId: "1:327865291955:web:a3788ac8a27d98952a0cc6"
};

initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

function calculateWSOPPoints(rank, entries) {
  if (rank === 1) return Math.round(10 * Math.sqrt(entries));
  if (rank === 2) return Math.round(7 * Math.sqrt(entries));
  if (rank === 3) return Math.round(5 * Math.sqrt(entries));
  if (rank <= Math.floor(entries * 0.15)) return Math.round(3 * Math.sqrt(entries - rank + 1));
  return 0;
}

const FSOPApp = () => {
  const [user, setUser] = useState(null);
  const [leagueStats, setLeagueStats] = useState([]);
  const [playerHistory, setPlayerHistory] = useState([]);
  const [year, setYear] = useState(new Date().getFullYear());
  const [alert, setAlert] = useState(null);

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, setUser);
    return () => unsub();
  }, []);

  useEffect(() => {
    if (user) {
      const statsRef = query(collection(db, `league_${year}`));
      onSnapshot(statsRef, (querySnapshot) => {
        const stats = [];
        querySnapshot.forEach((doc) => stats.push(doc.data()));
        stats.sort((a, b) => b.points - a.points);
        setLeagueStats(stats);
      });
    }
  }, [user, year]);

  useEffect(() => {
    if (user) fetchHistory();
  }, [user]);

  const fetchHistory = async () => {
    const history = [];
    for (let y = new Date().getFullYear(); y >= new Date().getFullYear() - 4; y--) {
      const snapshot = await getDocs(collection(db, `league_${y}`));
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.uid === user.uid) {
          history.push({ year: y, history: data.history });
        }
      });
    }
    setPlayerHistory(history);
  };

  const updateLeague = async (finalResults, winnings) => {
    const entries = finalResults.length;
    for (let i = 0; i < finalResults.length; i++) {
      const player = finalResults[i];
      const points = calculateWSOPPoints(player.rank, entries);
      const prize = winnings[i] || 0;
      const docRef = doc(db, `league_${year}`, player.uid);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        await updateDoc(docRef, {
          points: increment(points),
          games: increment(1),
          buyins: increment(1),
          winnings: increment(prize),
          [`history.${new Date().toISOString()}`]: player.rank
        });
      } else {
        await setDoc(docRef, {
          uid: player.uid,
          name: player.name,
          points,
          games: 1,
          buyins: 1,
          winnings: prize,
          history: {
            [new Date().toISOString()]: player.rank
          }
        });
      }
    }
  };

  const clearAllState = () => {
    localStorage.clear();
    setAlert("Local storage cleared. App reset.");
    setTimeout(() => window.location.reload(), 1500);
  };

  const handleLogout = () => {
    signOut(auth);
    setAlert("Logged out successfully.");
    setTimeout(() => setAlert(null), 3000);
  };

  return (
    <div className="min-h-screen bg-gray-900 text-white px-4 py-6 sm:px-6 lg:px-8">
      <header className="flex flex-col sm:flex-row justify-between items-center mb-6">
        <h1 className="text-3xl font-bold">FSOP Tournament League</h1>
        {user && (
          <div className="mt-4 sm:mt-0 flex gap-2">
            <button className="bg-yellow-600 px-4 py-2 rounded" onClick={clearAllState}>Clear All</button>
            <button className="bg-red-600 px-4 py-2 rounded" onClick={handleLogout}>Logout</button>
          </div>
        )}
      </header>

      {alert && <div className="bg-blue-500 text-white p-3 rounded mb-4 text-center">{alert}</div>}

      {user && (
        <>
          <section className="bg-gray-800 p-4 rounded-xl max-w-4xl mx-auto mb-8">
            <h2 className="text-2xl font-semibold mb-4">League Table - {year}</h2>
            <div className="mb-4">
              <label className="block mb-2">Select Year:</label>
              <select className="text-black p-2 rounded" value={year} onChange={(e) => setYear(Number(e.target.value))}>
                {[...Array(5)].map((_, i) => {
                  const y = new Date().getFullYear() - i;
                  return <option key={y} value={y}>{y}</option>;
                })}
              </select>
            </div>
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-gray-600">
                  <th>Name</th>
                  <th>üèÖ</th>
                  <th>Points</th>
                  <th>Games</th>
                  <th>Buyins</th>
                  <th>Winnings</th>
                </tr>
              </thead>
              <tbody>
                {leagueStats.map((p, i) => (
                  <tr key={p.uid} className="border-b border-gray-700">
                    <td>{p.name}</td>
                    <td>{i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : ''}</td>
                    <td>{p.points}</td>
                    <td>{p.games}</td>
                    <td>{p.buyins}</td>
                    <td>${p.winnings}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </section>

          <section className="max-w-3xl mx-auto bg-gray-800 p-4 rounded-xl">
            <h2 className="text-2xl font-semibold mb-4">My Tournament History</h2>
            {playerHistory.length === 0 ? (
              <p>No history found.</p>
            ) : (
              <ul className="space-y-4">
                {playerHistory.map((entry, idx) => (
                  <li key={idx} className="bg-gray-700 p-3 rounded">
                    <p className="font-bold">Year: {entry.year}</p>
                    <ul className="list-disc list-inside">
                      {Object.entries(entry.history).map(([date, rank]) => (
                        <li key={date}>{new Date(date).toLocaleDateString()} - Placed #{rank}</li>
                      ))}
                    </ul>
                  </li>
                ))}
              </ul>
            )}
          </section>
        </>
      )}

      <footer className="text-center text-sm text-gray-400 mt-10">
        &copy; {new Date().getFullYear()} FSOP League. All rights reserved.
      </footer>
    </div>
  );
};

export default FSOPApp;
